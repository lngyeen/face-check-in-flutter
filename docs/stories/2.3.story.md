# Story 2.3: Process Backend Responses & Display Toasts

## Status: Ready for TDD Development

## Story

- As a **user**
- I want **to see immediate feedback via a Toast notification when the backend sends a recognition result**
- so that **I know if my check-in was successful or not**

## Pre-Development Test Planning

### **Test Strategy**
- [ ] **Test Approach Defined**: Unit tests for response processing, Widget tests for toast display, Integration tests for complete recognition flow
- [ ] **Mock Strategy**: Mock WebSocket responses, Mock toast timing, Mock backend message formats
- [ ] **Test Data**: Sample success/failure responses, Malformed message scenarios, Various user data formats
- [ ] **Test Environment**: Response processing simulation with controlled message timing

### **TDD Development Plan**
```markdown
1. **RED Phase Tests**: List of failing tests to write first
   - [ ] Test 1: Backend response parsing and processing tests
   - [ ] Test 2: Toast notification system and display tests
   - [ ] Test 3: Success/failure response handling tests
   - [ ] Test 4: BLoC integration and state management tests
   
2. **GREEN Phase Implementation**: Minimal code to pass tests
   - [ ] Implementation 1: Basic response parsing and message processing
   - [ ] Implementation 2: Toast notification system with styling
   - [ ] Implementation 3: Success/failure response handling logic
   - [ ] Implementation 4: BLoC integration with toast state management
   
3. **REFACTOR Phase**: Code quality improvements
   - [ ] Refactor 1: Optimize response processing performance and error handling
   - [ ] Refactor 2: Improve toast system UX and animations
   - [ ] Refactor 3: Enhance success/failure handling robustness
   - [ ] Refactor 4: Clean up BLoC integration and state management
```

## Acceptance Criteria (TDD Format)

### AC1: Backend Response Processing
**Given** WebSocket connection receives backend messages  
**When** recognition result messages are received  
**Then** messages should be parsed correctly  
**And** success/failure status should be determined accurately

**Test Scenarios:**
- [ ] **Happy Path**: Valid success/failure responses parsed correctly
- [ ] **Error Case**: Malformed messages handled gracefully without crashes
- [ ] **Edge Case**: Various message formats and missing fields handled properly

**Test Implementation Required:**
- [ ] **Unit Test**: Response parsing logic and message validation
- [ ] **Widget Test**: Response processing status display
- [ ] **Integration Test**: End-to-end WebSocket message processing

### AC2: Toast Notification System
**Given** recognition results are processed  
**When** success or failure is determined  
**Then** appropriate toast should be displayed  
**And** toast should auto-hide after 3 seconds

**Test Scenarios:**
- [ ] **Happy Path**: Success/failure toasts display with correct styling and timing
- [ ] **Error Case**: Toast system handles rapid successive notifications
- [ ] **Edge Case**: Toast display during app state changes handled correctly

**Test Implementation Required:**
- [ ] **Unit Test**: Toast timing and auto-hide functionality
- [ ] **Widget Test**: Toast display, styling, and animations
- [ ] **Integration Test**: Complete toast notification workflow

### AC3: Success Response Handling
**Given** backend sends success response with user data  
**When** response contains non-empty faces array  
**Then** success toast should display with user's name  
**And** toast should have green styling as specified

**Test Scenarios:**
- [ ] **Happy Path**: Success responses display personalized welcome message
- [ ] **Error Case**: Missing user name handled with generic success message
- [ ] **Edge Case**: Multiple faces in response handled appropriately

**Test Implementation Required:**
- [ ] **Unit Test**: Success response parsing and user data extraction
- [ ] **Widget Test**: Success toast display and personalization
- [ ] **Integration Test**: Complete success recognition workflow

### AC4: Failure Response Handling
**Given** backend sends failure response  
**When** response contains empty faces array  
**Then** failure toast should display with appropriate message  
**And** toast should have orange/red styling as specified

**Test Scenarios:**
- [ ] **Happy Path**: Failure responses display appropriate error message
- [ ] **Error Case**: Various failure types handled with consistent messaging
- [ ] **Edge Case**: Failure responses during active streaming handled correctly

**Test Implementation Required:**
- [ ] **Unit Test**: Failure response processing and message generation
- [ ] **Widget Test**: Failure toast display and styling
- [ ] **Integration Test**: Complete failure recognition workflow

## Story Estimation

**Story Points**: 9 SP (increased from 5 SP for TDD)  
**Complexity**: Medium - JSON message processing + UI toast system + BLoC integration + TDD implementation  
**Risk Level**: Low - Final integration step, well-defined message format, TDD adds testing complexity  
**TDD Effort**: 4 SP additional for comprehensive response testing, toast UI testing, and integration testing  
**Estimation Method**: T-shirt sizing (Medium) adjusted for TDD overhead and testing complexity  
**Reference Stories**: Message processing and notification systems + TDD experience from previous stories  
**Assumptions**: Backend provides consistent message format, toast UI requirements are clear, TDD tooling configured

## Tasks / Subtasks

### **Phase 1: TDD Pre-Development**
- [ ] **Task 1**: Response Processing Test Strategy & Mock Setup
  - [ ] Design response processing testing strategy with message mocking
  - [ ] Setup mock WebSocket responses for success/failure scenarios
  - [ ] Prepare mock toast timing and display testing
  - [ ] Create test fixtures for various response formats
  - [ ] Document response processing testing approach

### **Phase 2: TDD Development (RED-GREEN-REFACTOR)**

#### **Task 2: Backend Response Processing - TDD Cycle**
**游댮 RED Phase:**
- [ ] Write failing tests for JSON response parsing
- [ ] Write failing tests for success/failure detection logic
- [ ] Write failing tests for malformed message handling
- [ ] Write failing tests for user data extraction

**游릭 GREEN Phase:**
- [ ] Create response parser for backend JSON responses
- [ ] Implement success/failure detection based on faces array
- [ ] Add malformed message handling with graceful errors
- [ ] Extract user information from success responses

**游댯 REFACTOR Phase:**
- [ ] Optimize response parsing performance
- [ ] Improve error handling and message validation
- [ ] Enhance user data extraction robustness
- [ ] Clean up response processing architecture

#### **Task 3: Toast Notification System - TDD Cycle**
**游댮 RED Phase:**
- [ ] Write failing tests for toast widget creation
- [ ] Write failing tests for auto-hide functionality (3 seconds)
- [ ] Write failing tests for success/failure styling
- [ ] Write failing tests for toast positioning and animations

**游릭 GREEN Phase:**
- [ ] Create ToastWidget with success and failure variants
- [ ] Implement auto-hide functionality with 3-second timer
- [ ] Apply proper styling (green for success, orange/red for failure)
- [ ] Add toast positioning and smooth animations

**游댯 REFACTOR Phase:**
- [ ] Optimize toast display performance and animations
- [ ] Improve toast styling and visual design
- [ ] Enhance auto-hide timing and user experience
- [ ] Clean up toast widget architecture

#### **Task 4: Success Response Handling - TDD Cycle**
**游댮 RED Phase:**
- [ ] Write failing tests for success response processing
- [ ] Write failing tests for user name extraction
- [ ] Write failing tests for personalized message creation
- [ ] Write failing tests for success toast display

**游릭 GREEN Phase:**
- [ ] Process success responses with non-empty faces array
- [ ] Extract user name from first face object (faceId)
- [ ] Create personalized success message ("Welcome, [Name]!")
- [ ] Display success toast with green styling

**游댯 REFACTOR Phase:**
- [ ] Optimize success response processing
- [ ] Improve user name extraction and fallback handling
- [ ] Enhance personalized message formatting
- [ ] Clean up success handling logic

#### **Task 5: Failure Response Handling - TDD Cycle**
**游댮 RED Phase:**
- [ ] Write failing tests for failure response processing
- [ ] Write failing tests for empty faces array detection
- [ ] Write failing tests for failure message creation
- [ ] Write failing tests for failure toast display

**游릭 GREEN Phase:**
- [ ] Process failure responses with empty faces array
- [ ] Create appropriate failure message ("Recognition Failed. Please try again.")
- [ ] Display failure toast with orange/red styling
- [ ] Handle different types of recognition failures

**游댯 REFACTOR Phase:**
- [ ] Optimize failure response processing
- [ ] Improve failure message clarity and user guidance
- [ ] Enhance failure toast styling and visibility
- [ ] Clean up failure handling logic

#### **Task 6: BLoC Integration & State Management - TDD Cycle**
**游댮 RED Phase:**
- [ ] Write failing tests for response processing events
- [ ] Write failing tests for toast display states
- [ ] Write failing tests for BLoC state transitions
- [ ] Write failing tests for debug logging integration

**游릭 GREEN Phase:**
- [ ] Create response processing events in CheckInEvent
- [ ] Add toast display states to CheckInState
- [ ] Update CheckInBloc to handle backend responses
- [ ] Emit appropriate states for UI updates and debug logging

**游댯 REFACTOR Phase:**
- [ ] Optimize BLoC response processing integration
- [ ] Improve state management and event handling
- [ ] Enhance debug logging and monitoring
- [ ] Clean up BLoC integration architecture

### **Phase 3: TDD Comprehensive Testing**
- [ ] **Task 7**: End-to-End Integration Testing
  - [ ] Add integration tests for complete recognition flow
  - [ ] Add stress tests for rapid response processing
  - [ ] Add UI tests for toast display during various app states
  - [ ] Verify test coverage meets 80% minimum for response processing

### **Phase 4: Documentation & Review**
- [ ] **Task 8**: Final Documentation & System Validation
  - [ ] Document complete face recognition system architecture
  - [ ] Create user experience and troubleshooting guide
  - [ ] Validate end-to-end system performance and reliability
  - [ ] Prepare system for production deployment
  - [ ] Create message parser for backend JSON responses
  - [ ] Implement success/failure detection logic based on data.faces array
  - [ ] Handle malformed message scenarios gracefully
  - [ ] Extract user information from success responses
  - [ ] Test with various message formats

- [ ] Task 2: Create Toast Notification System (AC: 4, 5)
  - [ ] Implement ToastWidget in core/widgets/
  - [ ] Create success and failure toast variants
  - [ ] Apply proper styling (colors, fonts, positioning)
  - [ ] Implement auto-hide functionality (3 seconds)
  - [ ] Test toast display and timing

- [ ] Task 3: Implement Success Response Handling (AC: 2)
  - [ ] Process success responses with non-empty faces array
  - [ ] Extract user name from first face object
  - [ ] Create personalized success message
  - [ ] Display success toast with proper styling
  - [ ] Test with various user data formats

- [ ] Task 4: Implement Failure Response Handling (AC: 3)
  - [ ] Process failure responses with empty faces array
  - [ ] Create appropriate failure message
  - [ ] Display failure toast with proper styling
  - [ ] Handle different types of recognition failures
  - [ ] Test failure scenarios

- [ ] Task 5: Integrate with BLoC State Management (AC: 1, 2, 3)
  - [ ] Create response processing events in CheckInEvent
  - [ ] Add toast display states to CheckInState
  - [ ] Update CheckInBloc to handle backend responses
  - [ ] Emit appropriate states for UI updates
  - [ ] Log response processing to debug view

- [ ] Task 6: End-to-End Testing and Validation (AC: 1-7)
  - [ ] Test complete flow from frame send to toast display
  - [ ] Validate message processing accuracy
  - [ ] Test toast display timing and styling
  - [ ] Verify error handling robustness
  - [ ] Conduct integration testing with real backend

## Dev Technical Guidance

### Backend Response Format (Real Sample Data)
```json
// Success Response
{
  "type": "frameResult",
  "data": {
    "faces": [
      {
        "faceId": "person_001",
        "isRecognized": true,
        "confidence": 0.92,
        "gender": "male",
        "age": 28,
        "mask": false,
        "bbox": [150, 120, 250, 220]
      }
    ],
    "faceImagePath": "https://storage.example.com/faces/camera1-2024-03-20T10:30:00.jpg",
    "cameraId": "camera_001",
    "timestamp": "2024-03-20T10:30:00.000Z",
    "processingTime": 250,
    "isCheckinSent": true,
    "originalSize": {"width": 1920, "height": 1080},
    "processedSize": {"width": 640, "height": 480},
    "annotatedImage": "base64_encoded_image_string_here"
  }
}

// Failure Response
{
  "type": "frameResult",
  "data": {
    "faces": [], // Empty array indicates failure
    "faceImagePath": "",
    "cameraId": "1",
    "timestamp": "2025-06-12T09:00:00.000Z",
    "processingTime": 1000,
    "isCheckinSent": false
  }
}
```

### Response Processing Logic
```dart
// Example response processing
class ResponseProcessor {
  static CheckInResult processResponse(Map<String, dynamic> response) {
    final faces = response['data']['faces'] as List;
    
    if (faces.isEmpty) {
      return CheckInResult.failure();
    } else {
      final firstFace = faces.first;
      return CheckInResult.success(
        userId: firstFace['faceId'],
        confidence: firstFace['confidence'],
      );
    }
  }
}
```

### Toast Implementation Specifications
```dart
// Example toast widget structure
class ToastWidget {
  static void showSuccess(BuildContext context, String userName) {
    // Display green toast with "Welcome, [userName]!"
  }
  
  static void showFailure(BuildContext context) {
    // Display orange/red toast with "Recognition Failed. Please try again."
  }
}
```

### UI/UX Styling Requirements
- **Success Toast**: Green background, "Welcome, [Name]!" message
- **Failure Toast**: Orange/red background, "Recognition Failed. Please try again."
- **Duration**: 3 seconds auto-hide
- **Position**: Overlay on main screen, non-blocking
- **Animation**: Smooth show/hide transitions

### State Management Integration
```dart
// Example states for toast handling
abstract class CheckInState {
  ToastStatus get toastStatus;
  String? get toastMessage;
  ToastType? get toastType;
}

enum ToastStatus {
  none,
  showing,
  hiding
}

enum ToastType {
  success,
  failure
}
```

### Error Handling Strategy
- **Malformed JSON**: Log error, continue operation
- **Missing Fields**: Use default values where possible
- **Invalid Message Type**: Ignore unknown message types
- **Processing Errors**: Display generic failure toast
- **Network Issues**: Handle at WebSocket service level

### Performance Considerations
- **JSON Parsing**: Efficient parsing of large responses
- **UI Updates**: Smooth toast animations without blocking
- **Memory Management**: Proper disposal of toast widgets
- **State Updates**: Efficient BLoC state transitions

### Testing Strategy
- **Unit Tests**: Test response parsing logic
- **Widget Tests**: Test toast display and timing
- **Integration Tests**: Test complete recognition flow
- **Error Tests**: Test various error scenarios
- **UI Tests**: Verify toast styling and positioning

### **TDD-Specific Requirements**
- **Test Coverage**: Minimum 80% for response processing, toast system, and BLoC integration
- **Test Quality**: Response tests should handle various message formats and timing scenarios
- **Test Organization**: Separate unit tests for parsing logic, widget tests for toast UI
- **Mock Strategy**: Use controlled response mocking and toast timing simulation

### **Response Processing TDD Testing Patterns**
```dart
// Example TDD approach for response processing testing
group('ResponseProcessor', () {
  test('should process success response with user name', () {
    // arrange
    final successResponse = {
      'type': 'frameResult',
      'data': {
        'faces': [
          {
            'faceId': 'person_001',
            'isRecognized': true,
            'confidence': 0.92,
          }
        ]
      }
    };

    // act
    final result = ResponseProcessor.processResponse(successResponse);

    // assert
    expect(result.isSuccess, isTrue);
    expect(result.userId, equals('person_001'));
    expect(result.confidence, equals(0.92));
  });

  test('should process failure response with empty faces', () {
    // arrange
    final failureResponse = {
      'type': 'frameResult',
      'data': {
        'faces': []
      }
    };

    // act
    final result = ResponseProcessor.processResponse(failureResponse);

    // assert
    expect(result.isSuccess, isFalse);
  });

  test('should handle malformed response gracefully', () {
    // arrange
    final malformedResponse = {'invalid': 'data'};

    // act & assert
    expect(
      () => ResponseProcessor.processResponse(malformedResponse),
      throwsA(isA<ResponseProcessingException>()),
    );
  });
});

// Toast widget testing
group('ToastWidget', () {
  testWidgets('should display success toast with user name', (tester) async {
    // arrange
    const userName = 'John Doe';

    // act
    await tester.pumpWidget(
      MaterialApp(
        home: Builder(
          builder: (context) {
            ToastWidget.showSuccess(context, userName);
            return Container();
          },
        ),
      ),
    );

    // assert
    expect(find.text('Welcome, $userName!'), findsOneWidget);
    expect(find.byType(ToastWidget), findsOneWidget);
  });

  testWidgets('should auto-hide toast after 3 seconds', (tester) async {
    // arrange & act
    await tester.pumpWidget(
      MaterialApp(
        home: Builder(
          builder: (context) {
            ToastWidget.showFailure(context);
            return Container();
          },
        ),
      ),
    );

    // assert initial state
    expect(find.byType(ToastWidget), findsOneWidget);

    // advance time by 3 seconds
    await tester.pump(Duration(seconds: 3));

    // assert toast is hidden
    expect(find.byType(ToastWidget), findsNothing);
  });
});

// BLoC integration testing
group('CheckInBloc Response Processing', () {
  blocTest<CheckInBloc, CheckInState>(
    'should emit success toast state when success response received',
    build: () => CheckInBloc(),
    act: (bloc) => bloc.add(
      CheckInEvent.faceDetectionResponse(
        FaceDetectionResponse(
          type: 'frameResult',
          faces: [FaceDetectionResult(faceId: 'person_001')],
        ),
      ),
    ),
    expect: () => [
      CheckInState.initial().copyWith(
        toastStatus: ToastStatus.showing,
        toastType: ToastType.success,
        toastMessage: 'Welcome, person_001!',
      ),
    ],
  );
});
```

### **Quality Standards**
- **Response Processing**: Robust parsing with comprehensive error handling
- **Toast System**: Smooth animations and proper timing (3-second auto-hide)
- **User Experience**: Clear success/failure feedback with appropriate styling
- **Error Handling**: Graceful handling of malformed responses without crashes
- **Testing**: Complete TDD coverage with response format and timing tests

## Definition of Done Checklist

### **TDD-Specific DoD**
- [ ] **Test-First Development**: All response processing features developed using TDD RED-GREEN-REFACTOR cycle
- [ ] **Test Coverage**: 80%+ coverage achieved for response processing, toast system, and BLoC integration
- [ ] **Test Quality**: Response tests handle various message formats, timing, and error scenarios properly
- [ ] **Test Documentation**: Response processing testing strategy and message format testing documented
- [ ] **Mock Strategy**: WebSocket responses and toast timing properly mocked for reliable testing

### **Standard DoD**
- [ ] **Code Review**: Reviewed by team member with response processing and TDD experience
- [ ] **Integration**: Response processing seamlessly integrated with WebSocket and toast systems
- [ ] **Documentation**: Complete face recognition system architecture and user guide documented
- [ ] **End-to-End Testing**: Complete recognition flow tested from camera to toast notification
- [ ] **Performance**: Response processing optimized for real-time operation without UI blocking

### **Story-Specific Requirements**
- [ ] **Response Processing**: Backend messages parsed correctly with success/failure detection
- [ ] **Toast System**: Success/failure toasts display with proper styling and 3-second auto-hide
- [ ] **Success Handling**: Personalized welcome messages display for recognized users
- [ ] **Failure Handling**: Appropriate error messages display for recognition failures
- [ ] **Error Handling**: Malformed messages handled gracefully without app crashes
- [ ] **BLoC Integration**: Response processing fully integrated with state management
- [ ] **Debug Integration**: Response processing events and results logged to debug view

### **User Experience Requirements**
- **Success Toast**: Green background with "Welcome, [Name]!" message
- **Failure Toast**: Orange/red background with "Recognition Failed. Please try again."
- **Toast Duration**: 3 seconds auto-hide with smooth animations
- **Toast Position**: Non-blocking overlay on main screen
- **Accessibility**: High contrast and screen reader support

### **Debug Logging Requirements**
Log the following to debug view:
- Incoming WebSocket messages (sanitized)
- Response processing results
- Toast display events
- Error conditions and handling
- User recognition details (non-sensitive)

### **Configuration Parameters**
- **Toast Duration**: Configurable display time
- **Toast Styling**: Theme-based color configuration
- **Message Templates**: Customizable success/failure messages
- **Animation Settings**: Toast transition configurations

### **System Completion**
- [ ] **Complete Face Recognition System**: All stories integrated and working end-to-end
- [ ] **Production Ready**: System validated for production deployment
- [ ] **Documentation Complete**: Full system documentation and troubleshooting guides
- [ ] **Team Handoff**: Complete system ready for team use and maintenance
- **Visual Indicators**: Clear success/failure visual cues
- **Font Sizes**: Readable text at various device sizes

## Story Progress Notes

### Agent Model Used: `<To be filled by implementing agent>`

### Completion Notes List

*{Implementation notes will be filled by the implementing agent}*

### Change Log
